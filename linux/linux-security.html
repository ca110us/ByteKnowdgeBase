<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux 安全 | 8B知识库</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.ea7cecec.css" as="style"><link rel="preload" href="/assets/js/app.4d603897.js" as="script"><link rel="preload" href="/assets/js/11.a5e033c8.js" as="script"><link rel="prefetch" href="/assets/js/10.fbb0508f.js"><link rel="prefetch" href="/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/assets/js/3.814d7077.js"><link rel="prefetch" href="/assets/js/4.75a5cdd8.js"><link rel="prefetch" href="/assets/js/5.95cbb943.js"><link rel="prefetch" href="/assets/js/6.3d7b26ae.js"><link rel="prefetch" href="/assets/js/7.74721aa4.js"><link rel="prefetch" href="/assets/js/8.b442d010.js"><link rel="prefetch" href="/assets/js/9.ce270a18.js"><link rel="prefetch" href="/assets/js/12.23c29f13.js"><link rel="prefetch" href="/assets/js/13.9649ca70.js"><link rel="prefetch" href="/assets/js/14.ca3148ba.js"><link rel="prefetch" href="/assets/js/15.7c4a717d.js"><link rel="prefetch" href="/assets/js/16.1cf87b10.js"><link rel="prefetch" href="/assets/js/17.75cf37c2.js"><link rel="prefetch" href="/assets/js/18.2975a34f.js"><link rel="prefetch" href="/assets/js/19.1faf98fc.js"><link rel="prefetch" href="/assets/js/20.d21bf986.js"><link rel="prefetch" href="/assets/js/21.3323d44d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ea7cecec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">8B知识库</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">8B知识库</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>coding-standards</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>linux</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/linux/linux-howtos.html" class="sidebar-link">Linux HowTos</a></li><li><a href="/linux/linux-iptables.html" class="sidebar-link">Iptables 使用指南</a></li><li><a href="/linux/linux-lnmp-optimizing.html" class="sidebar-link">LNMP Server优化</a></li><li><a href="/linux/linux-security.html" class="active sidebar-link">Linux 安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/linux/linux-security.html#linux-配置的安全" class="sidebar-link">Linux 配置的安全</a></li><li class="sidebar-sub-header"><a href="/linux/linux-security.html#nginx-配置的安全" class="sidebar-link">Nginx 配置的安全</a></li><li class="sidebar-sub-header"><a href="/linux/linux-security.html#php-配置的安全" class="sidebar-link">PHP 配置的安全</a></li><li class="sidebar-sub-header"><a href="/linux/linux-security.html#php-应用部署目录权限的安全" class="sidebar-link">PHP 应用部署目录权限的安全</a></li><li class="sidebar-sub-header"><a href="/linux/linux-security.html#redis-配置安全" class="sidebar-link">Redis 配置安全</a></li><li class="sidebar-sub-header"><a href="/linux/linux-security.html#mysql-配置安全" class="sidebar-link">MySQL 配置安全</a></li></ul></li><li><a href="/linux/linux-ubuntu-howtos.html" class="sidebar-link">Ubuntu HowTos</a></li><li><a href="/linux/linux-ubuntu-remove-home-directory-encryption.html" class="sidebar-link">Ubuntu 去除加密的 Home 目录</a></li><li><a href="/linux/linux-ubuntu-security.html" class="sidebar-link">Ubuntu 安全配置</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>mysql</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>nginx</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>oop</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>redis</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>tools</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>web-tour</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="linux-安全"><a href="#linux-安全" aria-hidden="true" class="header-anchor">#</a> Linux 安全</h1> <p>以下内容基于 Ubuntu Server。</p> <h2 id="linux-配置的安全"><a href="#linux-配置的安全" aria-hidden="true" class="header-anchor">#</a> Linux 配置的安全</h2> <h3 id="ssh加固"><a href="#ssh加固" aria-hidden="true" class="header-anchor">#</a> SSH加固</h3> <p>编辑 <code>/etc/ssh/sshd_config</code> 修改如下配置：</p> <div class="language- extra-class"><pre class="language-text"><code>PasswordAuthentication no # 禁止密码登陆
PermitRootLogin no # 禁止root登陆
</code></pre></div><p>可通过以下 shell 修改：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/^\(#\?\s*PasswordAuthentication\s.*\)/PasswordAuthentication no/g'</span> /etc/ssh/sshd_config
<span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/^\(#\?\s*PermitRootLogin\s.*\)/PermitRootLogin no/g'</span> /etc/ssh/sshd_config
<span class="token function">sed</span> -n -e <span class="token string">'/^\(#\?\s*PasswordAuthentication\s.*\)/p'</span> -e <span class="token string">'/^\(#\?\s*PermitRootLogin\s.*\)/p'</span> /etc/ssh/sshd_config
</code></pre></div><p>shell的最后一行输出了修改后的配置，请检查修改是否成功！配置需在SSH服务重启后才能生效：<code>sudo service ssh restart</code>。</p> <p>注意：在禁用<code>root</code>登陆之前，请先确认非root账号，能正常登陆服务器。</p> <h3 id="防火墙配置"><a href="#防火墙配置" aria-hidden="true" class="header-anchor">#</a> 防火墙配置</h3> <p>TODO.</p> <h2 id="nginx-配置的安全"><a href="#nginx-配置的安全" aria-hidden="true" class="header-anchor">#</a> Nginx 配置的安全</h2> <h3 id="静止未解析域名访问"><a href="#静止未解析域名访问" aria-hidden="true" class="header-anchor">#</a> 静止未解析域名访问</h3> <div class="language- extra-class"><pre class="language-text"><code>echo &quot;
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;
    return 404;
} &quot; | sudo tee /etc/nginx/sites-available/default
sudo service nginx reload
</code></pre></div><p>做此配置的目的是，防止IP被未备案的域名恶意解析，导致被工信部封杀。</p> <h3 id="关闭nginx版本号输出"><a href="#关闭nginx版本号输出" aria-hidden="true" class="header-anchor">#</a> 关闭Nginx版本号输出</h3> <p>编辑<code>/etc/nginx/nginx.conf</code>，修改配置<code>server_tokens off</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>sudo sed -i &quot;s/\\s*#*\s*server_tokens.*$/\\tserver_tokens off;/&quot; /etc/nginx/nginx.conf
</code></pre></div><p>配置此配置后，Nginx在Response的时候，不会输出Nginx的具体版本号，以免被攻击扫描器扫描得到Nginx版本号，做定向攻击。</p> <h2 id="php-配置的安全"><a href="#php-配置的安全" aria-hidden="true" class="header-anchor">#</a> PHP 配置的安全</h2> <h3 id="关闭expose-php"><a href="#关闭expose-php" aria-hidden="true" class="header-anchor">#</a> 关闭<code>expose_php</code></h3> <p>关闭此选项后，在 Http Response 的时候，不会输出PHP的版号，以免被攻击扫描器扫描得到Nginx版本号，做定向攻击。PHP 7开始，默认已经关闭此选项。</p> <h2 id="php-应用部署目录权限的安全"><a href="#php-应用部署目录权限的安全" aria-hidden="true" class="header-anchor">#</a> PHP 应用部署目录权限的安全</h2> <p>应遵循以下原则，确保PHP程序部署的安全性：</p> <ul><li>原则上一台服务器只部署一个应用；一台服务器上如需部署多个应用的，每个应用应该各自独立用户及用户组，以免相互影响。</li> <li>禁止使用<code>root</code>用户部署程序，推荐创建应用部署专属用户名<code>app</code>，用户组<code>app</code>。</li> <li>推荐应用部署在<code>/var/www</code>目录下。</li> <li>Nginx / PHP-FPM 进程运行的用户为<code>www-data</code>，且该用户的用户组为<code>www-data</code>，为了让 Nginx / PHP-FPM 能读取项目文件，应将<code>www-data</code>用户，加入<code>app</code>用户组。</li> <li>应用的<code>cli</code>程序，也应运行在<code>app</code>用户下。</li> <li>应用内的缓存、日志等需要写入的目录，设置权限为<code>770</code>；缓存文件、日志文件等文件的权限需设置为<code>777</code>，以使<code>cli</code>及<code>web</code>环境下都有权限对此类文件写入。</li></ul> <p>完整操作如下：</p> <ol><li>建立<code>app</code>用户及用户主目录，并设置登陆<code>shell</code>及目录权限</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">useradd</span> app -m -s /bin/bash
<span class="token function">sudo</span> <span class="token function">chmod</span> 750 /home/app
</code></pre></div><ol start="2"><li>创建<code>/var/www</code>目录，并设置权限</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /var/www
<span class="token function">sudo</span> <span class="token function">chown</span> app:app /var/www
<span class="token function">sudo</span> <span class="token function">chmod</span> 750 /var/www
</code></pre></div><ol start="3"><li>赋予<code>www-data</code>用户读取<code>app</code>目录的权限</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">usermod</span> -a -G app www-data
</code></pre></div><p>注：此步操作后，需重启 Nginx / PHP-FPM 服务才能生效：</p> <div class="language- extra-class"><pre class="language-text"><code>sudo service nginx restart
sudo service php-fpm restart
</code></pre></div><ol start="3"><li>赋予<code>app</code>用户 sudo 的权限</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">usermod</span> -a -G <span class="token function">sudo</span> app
</code></pre></div><ol start="4"><li>赋予<code>app</code>用户查看系统日志的权限</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">usermod</span> -a -G adm app
</code></pre></div><p>关于<code>adm</code>用户组的说明，参见 <a href="http://wiki.gacq.com/index.php/Debian_default_system_groups_description" target="_blank" rel="noopener noreferrer">Debian default system groups description<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。</p> <ol start="5"><li>设置<code>app</code>用户的密码，以便 sudo 时使用</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">passwd</span> app
</code></pre></div><ol start="6"><li><p>部署应用，并设置用户组及权限 (假设应用名为<code>myapp</code>)</p> <div class="language-shell extra-class"><pre class="language-shell"><code>deploy myapp to /var/www/myapp
<span class="token function">sudo</span> <span class="token function">chown</span> -Rf app:app /var/www/myapp
<span class="token function">sudo</span> <span class="token function">chmod</span> -Rf 750 /var/www/myapp <span class="token comment"># 如果 myapp 需要在线更新，那么这里权限应设置为 770 </span>
</code></pre></div></li> <li><p>设置应用的缓存、日志等目录可写。</p></li></ol> <p>需先安装<code>acl</code>，<code>sudo apt-get install acl</code>。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">su</span> app
<span class="token function">sudo</span> setfacl -dR -m u:www-data:rwX -m u:<span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>:rwX /var/www/myapp/var
<span class="token function">sudo</span> setfacl -R -m u:www-data:rwX -m u:<span class="token variable"><span class="token variable">$(</span><span class="token function">whoami</span><span class="token variable">)</span></span>:rwX /var/www/myapp/var
</code></pre></div><p>假设应用的缓存、日志目录都位于<code>/var/www/myapp/var</code>目录下。<code>setacl</code>此操作是为了让web及cli环境下，对缓存、日志等目录都可写，关于<code>setacl</code>参见：<a href="https://symfony.com/doc/current/setup/file_permissions.html" target="_blank" rel="noopener noreferrer">Setting up or Fixing File Permissions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，注意<code>setacl</code>命令对于 NFS 下的目录无效。</p> <p>参考： <a href="http://man.linuxde.net/setfacl" target="_blank" rel="noopener noreferrer">setfacl命令<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="redis-配置安全"><a href="#redis-配置安全" aria-hidden="true" class="header-anchor">#</a> Redis 配置安全</h2> <p>TODO.</p> <h2 id="mysql-配置安全"><a href="#mysql-配置安全" aria-hidden="true" class="header-anchor">#</a> MySQL 配置安全</h2> <p>TODO.</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/linux/linux-lnmp-optimizing.html" class="prev">
          LNMP Server优化
        </a></span> <span class="next"><a href="/linux/linux-ubuntu-howtos.html">
          Ubuntu HowTos
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/11.a5e033c8.js" defer></script><script src="/assets/js/app.4d603897.js" defer></script>
  </body>
</html>
