<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 主从同步配置 | 8B知识库</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.ea7cecec.css" as="style"><link rel="preload" href="/assets/js/app.4d603897.js" as="script"><link rel="preload" href="/assets/js/16.1cf87b10.js" as="script"><link rel="prefetch" href="/assets/js/10.fbb0508f.js"><link rel="prefetch" href="/assets/js/2.cda51ec0.js"><link rel="prefetch" href="/assets/js/3.814d7077.js"><link rel="prefetch" href="/assets/js/4.75a5cdd8.js"><link rel="prefetch" href="/assets/js/5.95cbb943.js"><link rel="prefetch" href="/assets/js/6.3d7b26ae.js"><link rel="prefetch" href="/assets/js/7.74721aa4.js"><link rel="prefetch" href="/assets/js/8.b442d010.js"><link rel="prefetch" href="/assets/js/9.ce270a18.js"><link rel="prefetch" href="/assets/js/11.a5e033c8.js"><link rel="prefetch" href="/assets/js/12.23c29f13.js"><link rel="prefetch" href="/assets/js/13.9649ca70.js"><link rel="prefetch" href="/assets/js/14.ca3148ba.js"><link rel="prefetch" href="/assets/js/15.7c4a717d.js"><link rel="prefetch" href="/assets/js/17.75cf37c2.js"><link rel="prefetch" href="/assets/js/18.2975a34f.js"><link rel="prefetch" href="/assets/js/19.1faf98fc.js"><link rel="prefetch" href="/assets/js/20.d21bf986.js"><link rel="prefetch" href="/assets/js/21.3323d44d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ea7cecec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">8B知识库</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">8B知识库</a></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>coding-standards</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>mysql</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/mysql/mysql-howtos.html" class="sidebar-link">MySQL HowTos</a></li><li><a href="/mysql/mysql-setup-master-slave.html" class="active sidebar-link">MySQL 主从同步配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mysql/mysql-setup-master-slave.html#安装-xtrabackup" class="sidebar-link">安装 XtraBackup</a></li><li class="sidebar-sub-header"><a href="/mysql/mysql-setup-master-slave.html#master-节点配置" class="sidebar-link">Master 节点配置</a></li><li class="sidebar-sub-header"><a href="/mysql/mysql-setup-master-slave.html#备份-master-数据" class="sidebar-link">备份 Master 数据</a></li><li class="sidebar-sub-header"><a href="/mysql/mysql-setup-master-slave.html#配置-mysql-slave" class="sidebar-link">配置 MySQL Slave</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>nginx</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>oop</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>redis</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>tools</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>web-tour</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="mysql-主从同步配置"><a href="#mysql-主从同步配置" aria-hidden="true" class="header-anchor">#</a> MySQL 主从同步配置</h1> <p>XtraBackup 为 MySQL 的备份工具，支持热备、增量备份等特性，具体特性参见<a href="https://www.percona.com/software/mysql-database/percona-xtrabackup" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="安装-xtrabackup"><a href="#安装-xtrabackup" aria-hidden="true" class="header-anchor">#</a> 安装 XtraBackup</h2> <p>在 Master、Slave 服务器上各自安装 XtraBackup。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">wget</span> https://repo.percona.com/apt/percona-release_0.1-4.<span class="token variable"><span class="token variable">$(</span>lsb_release -sc<span class="token variable">)</span></span>_all.deb
<span class="token function">sudo</span> dpkg -i percona-release_0.1-4.<span class="token variable"><span class="token variable">$(</span>lsb_release -sc<span class="token variable">)</span></span>_all.deb
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> percona-xtrabackup-24
</code></pre></div><p>参考 <a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/installation/apt_repo.html" target="_blank" rel="noopener noreferrer">Installing Percona XtraBackup on Debian and Ubuntu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="master-节点配置"><a href="#master-节点配置" aria-hidden="true" class="header-anchor">#</a> Master 节点配置</h2> <p><strong>开启 MySQL Binlog</strong></p> <p>编辑 <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>，配置 <code>log-bin</code> 以及 <code>server-id</code> 参数：</p> <div class="language- extra-class"><pre class="language-text"><code>log-bin            = /var/log/mysql/mysql-bin.log
server-id          = 1
</code></pre></div><p>参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/replication-howto-masterbaseconfig.html" target="_blank" rel="noopener noreferrer">Setting the Replication Master Configuration<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>重启MySQL</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">service</span> mysql restart
</code></pre></div><p><strong>检查 Binlog 是否成功开启</strong></p> <p>进入 MySQL 后执行：</p> <div class="language- extra-class"><pre class="language-text"><code>show variables like &quot;log_bin&quot;;
</code></pre></div><p>看到以下输出，表示配置成功：</p> <div class="language- extra-class"><pre class="language-text"><code>+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_bin       | ON    |
+---------------+-------+
1 row in set (0.00 sec)
</code></pre></div><p><strong>创建 MySQL 同步账号</strong></p> <p>进入 MySQL 后执行：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> REPL_USER@'SLAVE_IP<span class="token string">' IDENTIFIED BY '</span>REPL_PASSWORD'<span class="token punctuation">;</span>
</code></pre></div><p>注意：在语句执行之前，请替换<code>REPL_USER</code>、<code>SLAVE_IP</code>、<code>REPL_PASSWORD</code>。</p> <h2 id="备份-master-数据"><a href="#备份-master-数据" aria-hidden="true" class="header-anchor">#</a> 备份 Master 数据</h2> <p><strong>全量备份：</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> ~/backup
<span class="token function">sudo</span> xtrabackup --backup --user<span class="token operator">=</span>root --password<span class="token operator">=</span><span class="token string">'YOUR_PASSWORD'</span> --target-dir<span class="token operator">=</span>~/backup/mysql-backup
<span class="token function">sudo</span> xtrabackup --prepare --user<span class="token operator">=</span>root --password<span class="token operator">=</span><span class="token string">'YOUR_PASSWORD'</span> --target-dir<span class="token operator">=</span>~/backup/mysql-backup
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>此操作在 Master 服务器上，请确保你的备份目录所在的磁盘，空间是足够的！</p></div> <p>** 将备份数据复制到 Slave 服务器：**</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chown</span> -R <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> ~/backup/mysql-backup
<span class="token function">rsync</span> -avpP ~/backup/mysql-backup root@SLAVE_IP:backup/mysql-backup
</code></pre></div><h2 id="配置-mysql-slave"><a href="#配置-mysql-slave" aria-hidden="true" class="header-anchor">#</a> 配置 MySQL Slave</h2> <p><strong>停止 MySQL</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">service</span> mysql stop
</code></pre></div><p><strong>配置<code>server-id</code></strong></p> <p>编辑<code>/etc/mysql/mysql.conf.d/mysqld.cnf</code>，配置：</p> <div class="language- extra-class"><pre class="language-text"><code>server-id = 2
read-only=1
</code></pre></div><p><strong>重置数据</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo mv /var/lib/mysql  ~/backup/mysql-old-bak
sudo xtrabackup --move-back --target-dir=~/backup/mysql-backup
sudo chown -Rf mysql:mysql /var/lib/mysql
</code></pre></div><p><strong>启动 MySQL</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo service mysql start
</code></pre></div><p><strong>查看 Binlog 位置信息</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> ~/backup/mysql-backup/xtrabackup_binlog_info
</code></pre></div><p>显示如下信息：</p> <div class="language- extra-class"><pre class="language-text"><code>mysql-bin.000001   107
</code></pre></div><p>即下个操作步骤的<code>{MASTER_LOG_FILE}</code>、<code>{MASTER_LOG_POS}</code>参数的值。</p> <p><strong>Slave 连接 Maser</strong></p> <p>进入 Mysql 后执行：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>CHANGE MASTER <span class="token keyword">TO</span> MASTER_HOST<span class="token operator">=</span><span class="token string">'{MASTER_IP}'</span><span class="token punctuation">,</span>
    MASTER_USER<span class="token operator">=</span><span class="token string">'{REPL_USER}'</span><span class="token punctuation">,</span>
    MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'{REPL_PASSWORD}'</span><span class="token punctuation">,</span>
    MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">'{MASTER_LOG_FILE}'</span><span class="token punctuation">,</span>
    MASTER_LOG_POS<span class="token operator">=</span>{MASTER_LOG_POS}<span class="token punctuation">;</span>
</code></pre></div><p>启动 Slave：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">start</span> slave<span class="token punctuation">;</span>
</code></pre></div><h1 id="参考文献"><a href="#参考文献" aria-hidden="true" class="header-anchor">#</a> 参考文献</h1> <ul><li><a href="https://www.percona.com/doc/percona-xtrabackup/LATEST/howtos/setting_up_replication.html" target="_blank" rel="noopener noreferrer">How to setup a slave for replication in 6 simple steps with Percona XtraBackup<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/mysql/mysql-howtos.html" class="prev">
          MySQL HowTos
        </a></span> <span class="next"><a href="/nginx/nginx-howtos.html">
          Nginx HowTos
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/16.1cf87b10.js" defer></script><script src="/assets/js/app.4d603897.js" defer></script>
  </body>
</html>
